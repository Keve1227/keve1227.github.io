<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blockchain</title>

        <style>
            * {
                box-sizing: border-box;
            }

            :root {
                background-color: rgb(24, 22, 30);
                color: rgb(255, 255, 255);

                font-family: monospace;
                font-size: 16px;
                line-height: 1.5;

                scrollbar-width: thin;
                overflow-y: scroll;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .rail {
                height: calc(100lvh - 100dvh);
            }

            pre {
                margin: 0;
                padding: 1rem;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            samp {
                display: block;
                margin: 0;
                padding: 0;
            }
        </style>

        <script type="application/javascript">
            function bufferEncoder(_, value) {
                if (value instanceof ArrayBuffer) {
                    return new TextDecoder("ISO-8859-1").decode(value);
                }

                return value;
            }

            async function hashObject(o) {
                return new BigUint64Array(
                    await crypto.subtle.digest("SHA-256", new TextEncoder().encode(JSON.stringify(o, bufferEncoder)))
                );
            }

            function countBits(n) {
                const one = Object.getPrototypeOf(n).constructor(1);

                let count = 0;
                while (n) {
                    n &= n - one;
                    count++;
                }

                return count;
            }

            async function makeBlock(data, previous, difficulty) {
                const now = Date.now();

                const block = {
                    parent: previous?.hash ?? null,
                    timestamp: 0,
                    difficulty,
                    nonce: 0,
                    hash: new ArrayBuffer(32),
                    data,
                };

                let done = false;
                await Promise.race(
                    [...new Array(6)].map(async () => {
                        while (true) {
                            const timestamp = Date.now();
                            block.timestamp = timestamp;

                            const nonce = crypto.getRandomValues(new Uint32Array(1))[0];
                            block.nonce = nonce;

                            const hash = await hashObject(block);
                            if (done) return;

                            let bitCount = 0;
                            for (const n of hash) {
                                bitCount += countBits(n);
                            }

                            if (bitCount <= 128 - difficulty) {
                                block.timestamp = timestamp;
                                block.nonce = nonce;
                                new BigUint64Array(block.hash).set(hash);

                                done = true;
                                return;
                            }
                        }
                    })
                );

                return block;
            }

            async function* makeChain(data, difficulty) {
                let previous = null;

                for (const d of data) {
                    const block = await makeBlock(d, previous, difficulty);
                    yield block;
                    previous = block;
                }
            }

            async function verifyChain(chain) {
                let previous = null;

                for (const block of chain) {
                    if (previous?.hash && block.parent !== previous.hash) {
                        return false;
                    }

                    const hash = await hashObject({ ...block, hash: new ArrayBuffer(32) });

                    let bitCount = 0;
                    for (const n of hash) {
                        bitCount += countBits(n);
                    }

                    if (bitCount > 128 - block.difficulty) {
                        return false;
                    }

                    previous = block;
                }

                return true;
            }
        </script>
    </head>
    <body>
        <pre><samp></samp></pre>
        <div class="rail"></div>

        <script type="application/javascript">
            const log = document.querySelector("samp");
            const rail = document.querySelector(".rail");

            function print(...args) {
                log.textContent += args.join(" ") + "\n";
                rail.scrollIntoView(false);
            }

            (async () => {
                const data = ["Hello", "World", "Foo", "Bar", "Baz"];
                const chain = [];

                const start = performance.now();
                {
                    print("‚õèÔ∏è Mining...");
                    for await (const block of makeChain(data.slice(0, -1), 36)) {
                        chain.push(block);
                        print(JSON.stringify(block, bufferEncoder, 4));
                        print("‚õèÔ∏è Mining...");
                    }

                    chain.push(await makeBlock(data.at(-1), chain.at(-1), 36));
                    print(JSON.stringify(chain.at(-1), bufferEncoder, 4));
                }
                const end = performance.now();
                print(`‚è±Ô∏è ${end - start}ms, ${((end - start) / chain.length).toFixed(2)}ms per block`);

                print("üîó Verifying...");
                const valid = await verifyChain(chain);

                print(valid ? "‚úîÔ∏è Chain is valid" : "‚ùå Chain is invalid");
            })();
        </script>
    </body>
</html>
